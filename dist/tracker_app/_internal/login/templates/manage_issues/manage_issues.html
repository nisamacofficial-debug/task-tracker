{% extends "logins/base.html" %}
{% load static %}

{% block title %}Manage Issues ‚Äî Task Tracker{% endblock %}

{% block extra_head %}
<style>

.card-elev {
  background: var(--panel-bg);
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.04);
  padding: 16px;
}

/* Controls row */
.controls-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
  align-items: end;
}
.controls-row .clear-col {
  justify-self: end;
  display: flex;
  gap: .5rem;
  align-items: center;
}

.issues-table { margin-top: 12px; }
.issues-table table { background: var(--panel-bg); border-radius: 10px; overflow: hidden; }
.issues-table th { background: var(--brand); color: #fff; }
.tag-cell { font-size: .9rem; color: var(--muted); }

/* Inline editing */
.view-value { display: inline-block; min-width: 40px; }
.edit-input { min-width: 100px; max-width: 100%; }
.edit-input.d-none { display: none !important; }

/* Comments drawer */
.comments-panel {
  position: fixed !important;
  top: 0 !important;
  right: -420px !important;
  width: 420px;
  height: 100vh !important;
  background: #fff;
  box-shadow: -6px 0 30px rgba(0,0,0,0.06);
  padding: 18px;
  transition: right .28s ease;
  z-index: 99999 !important;
  overflow-y: auto;
}
.comments-panel.active { right: 0 !important; }
.comment-box { border:1px solid #eee; border-radius:10px; padding:10px 12px; margin-bottom:10px; background:#fbfdff; }
.close-panel { position:absolute; top:10px; right:12px; border:none; background:transparent; font-size:20px; color:#444; }

.toast-container { z-index:2000; }

/* Footer */
.footer {
  text-align: center;
  margin-top: 2rem;
  font-size: 13px;
  color: #888;
}

@media (max-width: 900px) {
  .comments-panel { width: 100%; right: -100%; }
  .comments-panel.active { right: 0; left: 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Manage Issues</h2>

  <div class="d-flex gap-2">
    <!-- Export dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        Export
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{% url 'export_issues_excel' %}">üìÑ Export to Excel (.xlsx)</a></li>
        <li><a class="dropdown-item" href="{% url 'export_issues_csv' %}">üìë Export to CSV (.csv)</a></li>
      </ul>
    </div>

    <!-- Add issue -->
    <a href="{% url 'add_issue' %}" class="btn" style="background:var(--brand); color:#fff; border-radius:8px; padding:.5rem .9rem;">
      + Add New Issue
    </a>
  </div>
</div>

<div class="card-elev">
  <div class="controls-row">
    <div>
      <label class="form-label mb-0 small-muted">Status</label>
      <select id="statusFilter" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="in_progress">In Progress</option>
        <option value="blocked">Blocked</option>
        <option value="closed">Closed</option>
      </select>
    </div>

    <div>
      <label class="form-label mb-0 small-muted">Tag</label>
      <select id="tagFilter" class="form-select form-select-sm">
        <option value="">All</option>
        {% for tag in tags %}
        <option value="{{ tag.name }}">{{ tag.name|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="min-width:220px;">
      <label class="form-label mb-0 small-muted">Search</label>
      <input id="searchInput" type="search" class="form-control form-control-sm" placeholder="title or description">
    </div>

    <div class="clear-col">
      <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Clear</button>
    </div>
  </div>
</div>

<div class="issues-table card-elev mt-3">
  <div class="table-responsive">
    <div class="mb-3 d-flex gap-2">
      <button id="deleteSelectedBtn" class="btn btn-danger btn-sm">Delete Selected</button>
      <button id="deleteAllBtn" class="btn btn-outline-danger btn-sm">Delete All</button>
    </div>

    <table class="table align-middle mb-0" id="issuesTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>ID</th>
          <th>Title</th>
          <th>Description</th>
          <th>Status</th>
          <th>Due Date</th>
          <th>Tags</th>
          <th>Created By</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
        <tr data-issue-id="{{ issue.id }}">
          <td><input type="checkbox" class="row-check" value="{{ issue.id }}"></td>
          <td>{{ issue.id }}</td>
          <td class="title-cell">{{ issue.title }}</td>
          <td class="desc-cell">{{ issue.description|truncatechars:60 }}</td>

          <td class="status-cell" data-issue-id="{{ issue.id }}">
            <div class="d-flex align-items-center gap-2">
              <span class="status-text">
                {% if issue.status == 'closed' %}
                <span class="badge bg-success">{{ issue.status|title }}</span>
                {% elif issue.status == 'in_progress' %}
                <span class="badge bg-warning text-dark">{{ issue.status|title }}</span>
                {% else %}
                <span class="badge bg-secondary">{{ issue.status|title }}</span>
                {% endif %}
              </span>
              <select class="status-select form-select form-select-sm d-none">
                <option value="open" {% if issue.status == 'open' %}selected{% endif %}>Open</option>
                <option value="in_progress" {% if issue.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="blocked" {% if issue.status == 'blocked' %}selected{% endif %}>Blocked</option>
                <option value="closed" {% if issue.status == 'closed' %}selected{% endif %}>Closed</option>
              </select>
            </div>
          </td>

          <td class="editable-field" data-issue-id="{{ issue.id }}" data-field="due_date">
            <span class="view-value">{{ issue.due_date|default:"‚Äî" }}</span>
            <input type="date" class="edit-input form-control form-control-sm d-none" value="{% if issue.due_date %}{{ issue.due_date|date:'Y-m-d' }}{% endif %}">
          </td>

          <td class="editable-field tag-cell" data-issue-id="{{ issue.id }}" data-field="tag">
            <span class="view-value">{% if issue.tag %}{{ issue.tag }}{% else %}‚Äî{% endif %}</span>
            <input type="text" class="edit-input form-control form-control-sm d-none" value="{% if issue.tag %}{{ issue.tag }}{% endif %}">
          </td>

          <td>{{ issue.created_by.username }}</td>
          <td>{{ issue.created_at|date:"Y-m-d H:i" }}</td>

          <td class="d-flex gap-1">
            <button type="button" class="btn btn-sm btn-outline-info view-comments" data-issue-id="{{ issue.id }}">üí¨</button>
            <a href="{% url 'edit_issue' issue.id %}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</a>
            <button type="button" class="btn btn-sm btn-outline-danger delete-issue" data-issue-id="{{ issue.id }}">üóëÔ∏è</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted py-4">No issues found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Comments drawer -->
<aside class="comments-panel" id="commentsPanel" aria-hidden="true">
  <button class="close-panel" id="closePanel">&times;</button>
  <h5 class="mb-2">Comments</h5>
  <div id="commentsList" class="mb-3 text-muted">Select an issue to view comments.</div>

  <form id="commentForm" class="mt-2 d-none">
    <div class="mb-3">
      <textarea id="newComment" rows="3" class="form-control" placeholder="Add a comment..."></textarea>
    </div>
    <button type="submit" class="btn btn-primary w-100">Post Comment</button>
  </form>
</aside>

<!-- Footer -->
<div class="footer">
  Powered by <strong>Nisamudheen</strong> | Contact: <a href="mailto:nisamac2121@gmail.com">nisamac2121@gmail.com</a>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function () {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  function jsonPost(url, data) {
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(data || {})
    }).then(r=>r.json());
  }

  // Filters
  const statusFilter = document.getElementById('statusFilter');
  const tagFilter = document.getElementById('tagFilter');
  const searchInput = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearFilters');

  function matchesFilter(row) {
    const title = row.querySelector('.title-cell')?.innerText.toLowerCase() || '';
    const desc = row.querySelector('.desc-cell')?.innerText.toLowerCase() || '';
    const statusText = row.querySelector('.status-text')?.innerText.toLowerCase() || '';
    const tagText = row.querySelector('.tag-cell')?.innerText.toLowerCase() || '';

    const s = statusFilter.value.trim().toLowerCase();
    const t = tagFilter.value.trim().toLowerCase();
    const q = searchInput.value.trim().toLowerCase();

    return (!s || statusText.includes(s)) && (!t || tagText.includes(t)) && (!q || title.includes(q) || desc.includes(q));
  }

  function applyFilters() {
    document.querySelectorAll('#issuesTable tbody tr[data-issue-id]').forEach(row => {
      row.style.display = matchesFilter(row) ? '' : 'none';
    });
  }

  [statusFilter, tagFilter, searchInput].forEach(el=>{
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });

  clearBtn.addEventListener('click', ()=>{
    statusFilter.value=''; tagFilter.value=''; searchInput.value='';
    applyFilters();
  });

  applyFilters();

  // Bulk select
  document.getElementById('selectAll').addEventListener('change', function(){
    const checked = this.checked;
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = checked);
  });

  // Bulk delete selected
  document.getElementById('deleteSelectedBtn').addEventListener('click', function(){
    const ids = [...document.querySelectorAll('.row-check:checked')].map(cb=>cb.value);
    if(ids.length===0){ alert("No items selected."); return; }
    if(!confirm(`Delete ${ids.length} selected issue(s)?`)) return;

    jsonPost("/delete-multiple/", { ids }).then(data=>{
      if(data.success) location.reload();
      else alert("Failed to delete selected issues.");
    });
  });

  // Delete all
  document.getElementById('deleteAllBtn').addEventListener('click', function(){
    if(!confirm("Delete ALL issues? This cannot be undone!")) return;
    jsonPost("/delete-all/", {}).then(data=>{
      if(data.success) location.reload();
      else alert("Failed to delete all issues.");
    });
  });

})();
</script>
{% endblock extra_js %}
